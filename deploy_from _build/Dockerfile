FROM node:16-alpine as base

RUN mkdir -p /usr/src/app

WORKDIR /usr/src/app

ARG APP_LEVEL
ARG APP_LOGGER
ARG AZURE_KEY
ARG BUCKEY_KEY
ARG CLIENT_URL
ARG CLOUDAMQP_URL
ARG DB_HOST
ARG DB_NAME
ARG DB_PASSWORD
ARG DB_PORT
ARG DB_USER
ARG FROM
ARG JWT_SECRET_KEY
ARG MAIL_HOST
ARG MAIL_PASS
ARG MAIL_PORT
ARG MAIL_USER
ARG RESET_EXCHANGE
ARG RESET_PASSWORD_QUEUE
ARG RESET_ROUTING_KEY
ARG SERVER_URL
ARG SIGNUP_EXCHANGE
ARG SIGNUP_QUEUE
ARG SIGNUP_ROUTING_KEY
ARG STORAGE_CONNECTION_STRING
ARG TOKEN_EXPIRES

ENV APP_LEVEL $APP_LEVEL
ENV APP_LOGGER $APP_LOGGER
ENV AZURE_KEY $AZURE_KEY
ENV BUCKEY_KEY $BUCKEY_KEY
ENV CLIENT_URL $CLIENT_URL
ENV CLOUDAMQP_URL $CLOUDAMQP_URL
ENV DB_HOST $DB_HOST
ENV DB_NAME $DB_NAME
ENV DB_PASSWORD $DB_PASSWORD
ENV DB_PORT $DB_PORT
ENV DB_USER $DB_USER
ENV FROM $FROM
ENV JWT_SECRET_KEY $JWT_SECRET_KEY
ENV MAIL_HOST $MAIL_HOST
ENV MAIL_PASS $MAIL_PASS
ENV MAIL_PORT $MAIL_PORT
ENV MAIL_USER $MAIL_USER
ENV RESET_EXCHANGE $RESET_EXCHANGE
ENV RESET_PASSWORD_QUEUE $RESET_PASSWORD_QUEUE
ENV RESET_ROUTING_KEY $RESET_ROUTING_KEY
ENV SERVER_URL $SERVER_URL
ENV SIGNUP_EXCHANGE $SIGNUP_EXCHANGE
ENV SIGNUP_QUEUE $SIGNUP_QUEUE
ENV SIGNUP_ROUTING_KEY $SIGNUP_ROUTING_KEY
ENV STORAGE_CONNECTION_STRING $STORAGE_CONNECTION_STRING
ENV TOKEN_EXPIRES $TOKEN_EXPIRES

COPY package.json /usr/src/app/

RUN npm install && npm install -g sequelize-cli

COPY . /usr/src/app

EXPOSE 3000

CMD [ "npm", "start" ]